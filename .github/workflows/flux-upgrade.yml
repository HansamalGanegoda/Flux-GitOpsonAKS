name: Flux Self-Upgrade

on:
  push:
    branches:
      - main
    paths:
      - 'clusters/my-cluster/flux-system/flux-version.txt'
  workflow_dispatch:

jobs:
  upgrade-flux:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2️⃣ Set Flux version from file
      - name: Set Flux version
        id: flux-version
        run: |
          VERSION=$(cat clusters/my-cluster/flux-system/flux-version.txt)
          echo "FLUX_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Flux version set to $VERSION"

      # 3️⃣ Install Flux CLI
      - name: Install Flux CLI
        run: |
          curl -s https://fluxcd.io/install.sh | sudo FLUX_VERSION=$FLUX_VERSION bash
          flux --version

      # 4️⃣ Azure login
      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.azure }}

      # 5️⃣ Get AKS credentials
      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group SasinduAKS --name sasinduAKS --overwrite-existing

      # 6️⃣ Upgrade Flux if already bootstrapped, otherwise install
      - name: Upgrade or Install Flux
        run: |
          # Check if Flux is already installed
          if kubectl get ns flux-system &> /dev/null; then
            echo "Flux detected, upgrading using bootstrap..."
            flux bootstrap github \
              --owner=HansamalGanegoda \
              --repository=Flux-GitOpsonAKS \
              --branch=main \
              --path=clusters/my-cluster/flux-system \
              --personal \
              --version=v$FLUX_VERSION \
              --components=source-controller,kustomize-controller,helm-controller,notification-controller
          else
            echo "No Flux installation found, installing fresh..."
            flux install --version=v$FLUX_VERSION --namespace=flux-system \
              --components=source-controller,kustomize-controller,helm-controller,notification-controller
          fi

      # 7️⃣ Verify Flux version in AKS
      - name: Verify Flux components
        run: |
          kubectl -n flux-system get deploy -o yaml | grep image
